\documentclass[10pt]{article}

\usepackage{blindtext} % Package to generate dummy text throughout this template 

\usepackage[sc]{mathpazo} % Use the Palatino font
\usepackage[T1]{fontenc} % Use 8-bit encoding that has 256 glyphs
\linespread{1.05} % Line spacing - Palatino needs more space between lines
\usepackage{microtype} % Slightly tweak font spacing for aesthetics

\usepackage[english]{babel} % Language hyphenation and typographical rules

\usepackage[hmarginratio=1:1,top=32mm,columnsep=20pt]{geometry} % Document margins
%\usepackage[hang, small,labelfont=bf,up,textfont=it,up]{caption} % Custom captions under/above floats in tables or figures
\usepackage[small,labelfont=bf,up,textfont=it,up]{caption}
\usepackage{sidecap}
\usepackage{floatrow}

\usepackage{booktabs} % Horizontal rules in tables

\usepackage{enumitem} % Customized lists
\setlist[itemize]{noitemsep} % Make itemize lists more compact

\usepackage{abstract} % Allows abstract customization
\renewcommand{\abstractnamefont}{\normalfont\bfseries} % Set the "Abstract" text to bold
\renewcommand{\abstracttextfont}{\normalfont\small\itshape} % Set the abstract itself to small italic text

\usepackage{titlesec} % Allows customization of titles
\renewcommand\thesection{\Roman{section}} % Roman numerals for the sections
\renewcommand\thesubsection{\roman{subsection}} % roman numerals for subsections
\titleformat{\section}[block]{\large\scshape\centering}{\thesection.}{1em}{} % Change the look of the section titles
\titleformat{\subsection}[block]{\large}{\thesubsection.}{1em}{} % Change the look of the section titles

\usepackage{fancyhdr} % Headers and footers
\pagestyle{fancy} % All pages have headers and footers
\fancyhead{} % Blank out the default header
\fancyfoot{} % Blank out the default footer
%\fancyhead[C]{CRes User Manual $\bullet$ 2019 $\bullet$ Watson} % Custom header text
\fancyhead[C]{CRes User Manual~~~$\bullet$~~~Watson~~~$\bullet$~~~2019} % Custom header text
\fancyfoot[RO,LE]{\thepage} % Custom footer text

\usepackage{titling} % Customizing the title section

\usepackage{hyperref} % For hyperlinks in the PDF

% math packages
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsfonts}

% figure packages
\usepackage{graphicx}

\usepackage{natbib} % bibliography

\usepackage{listings} % for including code snippets
\usepackage{color}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
 
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    %numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
 
\lstset{style=mystyle}



%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\setlength{\droptitle}{-4\baselineskip} % Move the title up

\pretitle{\begin{center}\Huge\bfseries} % Article title formatting
\posttitle{\end{center}} % Article title closing formatting
\title{CRes User Guide} % Article title
\author{%
\textsc{Leighton M. Watson} \\% Your name
\normalsize Stanford University \\ % Your institution
\normalsize \href{mailto:leightonwatson@stanford.edu}{leightonwatson@stanford.edu} % Your email address
%\and % Uncomment if 2 authors are required, duplicate these 4 lines if more
%\textsc{Jane Smith}\thanks{Corresponding author} \\[1ex] % Second author's name
%\normalsize University of Utah \\ % Second author's institution
%\normalsize \href{mailto:jane@smith.com}{jane@smith.com} % Second author's email address
}
\date{\today} % Leave empty to omit a date
\renewcommand{\maketitlehookd}{%
}

%----------------------------------------------------------------------------------------

\begin{document}

% Print the title
\maketitle

%----------------------------------------------------------------------------------------
%	ARTICLE CONTENTS
%----------------------------------------------------------------------------------------

\section{Introduction}
{\bf CRes} (Crater Resonance) is a one-dimensional (1D) numerical method for solving the linear acoustic wave equation within a volcanic crater. For a specified crater geometry and excitation source at the base of the crater, {\bf CRes} computes the velocity and pressure at the crater outlet and can propagate the signal to an infrasound receiver some distance from the outlet. The linear acoustic wave equation is written in terms of two first-order differential equations for pressure and acoustic flow and is solved by {\bf CRes} using a finite-difference frequency-domain method. {\bf CRes} is written in \texttt{MATLAB} and runs efficiently on a standard desktop/laptop computer. For more details and examples of the application of {\bf CRes} see:
\begin{itemize}
\item Watson, L. M., Dunham, E. M., and Johnson, J. B. Simulation and inversion of harmonic infrasound from open-vent volcanoes using an efficient quasi-1D crater model, \emph{Journal of Volcanology and Geothermal Research}, submitted 28 Dec 2018, revised 19 Mar 2019.
\item Johnson, J. B., Watson, L. M., Palma, J. L., Dunham, E. M., and Anderson, J. F. (2018) Forecasting the eruption of an open-vent volcano using resonant infrasound tones, \emph{Geophysical Research Letters}, 45, \href{https://doi.org/10.1002/2017GL076506}{https://doi.org/10.1002/2017GL076506}.
\end{itemize}

\section{Directory}
\begin{itemize}
\item {\bf demo} - script files for demonstration
\begin{itemize}
\item \texttt{exampleX.m} - example script files
\item \texttt{Johnson2018.mat} - example crater geometry from \citet{Johnson2018}
\item \texttt{Richardson2014.mat} - example crater geometry from \citet{Richardson2014}
\end{itemize}

\item {\bf doc} - documentation including user guide and license file
\item{\bf source/SBPoperators} - function files associated with numerical implementation
\item {\bf source/resonance} - function files for {\bf CRes}
\begin{itemize}
\item \texttt{resonance1d.m} - main code
\item \texttt{problemParameters} - specifies model parameters
\item \texttt{pressurePerturbation.m} - computes pressure perturbation (infrasound signal) at a distance away from the crater
\item \texttt{flanged\_opening.m} - treatment of open end of crater
\item \texttt{resPeakProps.m} - computes resonant frequency and quality factor of spectral peaks
\item \texttt{sourceFunction.m} - specifies source function (Gaussian or Brune)
\end{itemize}
\end{itemize}

{\bf CRes} is freely available online at \href{https://github.com/leighton-watson/CRes}{https://github.com/leighton-watson/CRes} and is distributed under the MIT license (see \texttt{license.txt} for details). 

%%%%%%%%%%%%%%%%
%% MODEL DESCRIPTION %%
%%%%%%%%%%%%%%%%
\section{Model Description}
Here, I provide an overview of {\bf CRes}. For more details see Watson et al., (2019). {\bf CRes} assumes linear wave propagation, which enables the infrasound signal, $\Delta p$, observed at a distance, $r$, from the crater outlet to be written as:
\begin{equation}
\Delta p(t,r) = T(t,r) \ast s(t)
\label{eq:model time}
\end{equation}
where $T$ is the acoustic response function, which depends on the crater and atmospheric properties, that describes the theoretical infrasound signal generated by an impulsive excitation at the base of the crater, and $s(t)$ is the finite-duration source at the base of the crater. The source expressed as a volumetric flow rate of air within the crater being push upwards, or pulled downwards, by the source process (m$^3$/s). {\bf CRes} is written in the frequency domain where the time-domain convolution is replaced by multiplication:
\begin{equation}
\Delta p(\omega,r) = T(\omega,r) s(\omega),
\label{eq:model freq}
\end{equation}
where $\omega$ is the angular frequency.

\begin{figure}[h!]
\centering
\includegraphics[width=1\textwidth]{Fig_Workflow}
\caption{The modeling workflow is to start with a specified source function, $s(t)$, and take the Fourier transform to get $s(\omega)$. The infrasound signal in the frequency domain, $\Delta p(\omega,r)$, is calculated by equation~\ref{eq:model freq} and the inverse Fourier transform is used to obtain the infrasound signal in the time domain, $\Delta p(t,r)$. }
\end{figure}

The acoustic response function, $T$, is divided into 1.) the crater acoustic response function, $C$, which describes wave propagation and resonant modes inside the volcanic crater, and 2.) the atmospheric response function, $P$, which describes acoustic radiation from the crater to the infrasound station. The crater acoustic response, $C$, is defined as
\begin{equation}
C(\omega) = \frac{U(\omega,0)}{s(\omega)},
\label{eq:crater response function}
\end{equation}
 where $U$ is the volumetric flow rate associated with acoustic waves ($U=vA$ is the acoustic flow where $A$ is the cross-sectional area, which can vary as a function of depth, and $v$ is the vertical particle velocity). The atmosphere response function, $P$, is defined as
\begin{equation}
P(\omega,r) = \frac{\Delta p(\omega,r)}{U(\omega,0)},
\label{eq:atmospheric response function}
\end{equation}
 allowing the acoustic response function, $T$, to be expressed as{}
\begin{equation}
T(\omega,r) = C(\omega) P(\omega,r) = \frac{U(\omega,0)}{s(\omega)} \frac{\Delta p(\omega,r)}{U(\omega,0)} = \frac{\Delta p(\omega,r)}{s(\omega)}.
\label{eq:transfer function}
\end{equation}

\subsection{Crater Acoustic Response Function}

This section describes how to calculate the crater acoustic response function, $C$. The crater is modeled as quasi-one-dimensional (allowing for changes in cross-sectional area with depth) and axisymmetric. Acoustic waves inside the crater are described by linear acoustics written as a system of first-order partial differential equations:
\begin{align}
\frac{\partial U}{\partial t} + \frac{A}{\rho} \frac{\partial p}{\partial z} & = 0, \\
\frac{\partial p}{\partial t} + \frac{K}{A} \frac{\partial U}{\partial z} & = 0,
\end{align}
where $p$ is the pressure. The air inside the crater is described as an ideal gas with ambient density, $\rho$, and fluid bulk modulus, $K$, which is  proportional  to the ambient pressure for an ideal gas. Density and pressure are related by the ideal gas equation of state:
\begin{equation}
p = \rho R T,
\label{eq:ideal gas}
\end{equation}
where $R$ is the specific gas constant and $T$ is the temperature, not to be confused with response function $T$ in equations (\ref{eq:model time}) and (\ref{eq:model freq}). The speed of sound is
\begin{equation}
c = \sqrt{\gamma R T},
\label{eq:sound speed}
\end{equation}
where $\gamma$ is the ratio of specific heats ($\gamma=1.4$ for diatomic gases such as air).


\begin{figure}[t!]
\centering
\floatbox[{\capbeside\thisfloatsetup{capbesideposition={left,center},capbesidewidth=4.5cm}}]{figure}[\FBwidth]
{\caption{Schematic of model. The infrasound signal, $\Delta p$, observed at a distance $r$ from the crater is related to the excitation source  at the base of the crater, $s$, by the acoustic response function, $T$, which includes the crater acoustic response function that describes wave propagation inside the crater and associated resonant modes, and  the atmosphere response function, which describes acoustic radiation from the crater outlet to the receiver.}
\label{fig:charlesX}}
{\includegraphics[width=8cm]{Fig_ModelSchematic}}
\end{figure}

The governing equations are solved in the frequency domain and can be written as a system of first-order ordinary differential equations:
\begin{align}
i \omega U + \frac{A}{\rho} \frac{\partial p}{\partial z} & = 0, 
\label{eq:govern eq 1} \\
i \omega p + \frac{K}{A} \frac{\partial U}{\partial z} & = 0.
\label{eq:govern eq 2}
\end{align}

The model requires two boundary conditions, one at the bottom of the crater and one at the crater outlet. At the bottom, $z=-L$, of the crater the acoustic flow is specified as the source-time function:
\begin{equation}
U(t,-L) = s(t) = \iint_{A(L)} v(x,y,t)~dx~dy.
\label{eq:volumetric flow rate}
\end{equation}
At the crater outlet, $z=0$, the pressure and acoustic flow are related by the terminating impedance, $Z_T$ \citep{Rossing2004}:
\begin{equation}
\frac{p(\omega,0)}{U(\omega,0)} = Z_T(\omega).
\end{equation}
A constant pressure boundary condition could be applied could be applied at the outlet. However, this results in perfect reflection of acoustic waves. In order to allow acoustic waves to escape into the atmosphere and be recorded as infrasound, a more accurate description of the outlet is required. Here, a flanged opening is assumed \citep{Olson1957,Kinsler2000,Rossing2004} and the terminating impedance is given by  \citep{Rossing2004}
\begin{equation}
Z_T = R + i X,
\label{eq:terminating impedance}  
\end{equation}
 where $i$ indicates the imaginary unit, $R$ is the acoustic resistance
\begin{equation}
R = Z_a \bigg[ \frac{(ka)^2}{2} - \frac{(ka)^4}{2^2 \cdot 3} + \frac{(ka)^6}{2^2 \cdot 3^2 \cdot 4} - \hdots \bigg],
\label{eq:acoustic resistance}
\end{equation}
 and $X$ is the acoustic reactance
\begin{equation}
X = \frac{Z_a}{\pi (ka)^2} \bigg[ \frac{(2ka)^3}{3} - \frac{(2ka)^5}{3^2 \cdot 5} + \frac{(2ka)^7}{3^2 \cdot 5^2 \cdot 7} - \hdots \bigg],   
\label{eq:acoustic reactance}
\end{equation}
 with $k$ the wavenumber, $a$ the crater radius at the outlet and $Z_a = \rho_a c_a/A(0)$ where $\rho_a$ and $c_a$ are the density and speed of sound in the atmosphere, respectively, and $A(0)$ is the cross-sectional area of the crater outlet. 

\subsection{Atmosphere Response Function}
This section describes how to calculate the atmosphere response function, $P$. Propagation of the infrasound signal from the crater outlet to the receiver is described as axisymmetric radiation from a baffled piston embedded in an infinite plane \citep{Rossing2004}:
\begin{equation}
\Delta p(\omega,r) = i \omega \exp(-ikr) \frac{\rho_a a^2}{2r} \bigg[ \frac{2J_1 (ka \sin \theta)}{ka \sin \theta} \bigg] \frac{U(\omega,0)}{\pi a^2},
\label{eq:acoustic radiation}
\end{equation}
where $J_1$ is a Bessel function of order one, $\theta$ is the angle between the negative $z-$axis and the receiver (e.g., $\theta=\pi/2$ for a receiver located on the plane perpendicular to crater orientation), $\rho_a$ is the density of the atmosphere, and $a$ is the crater radius at the outlet. The baffled piston model reduces to the monopole source description \cite[e.g.,][]{Woulff1976,Johnson2014} for radiation in a half-space in the low frequency limit when $ka~\ll~1$,
\begin{equation}
\Delta p(\omega, r) = i \omega \exp(-ikr) \frac{\rho_a a^2}{2r}\frac{U(\omega,0)}{\pi a^2}.
\label{eq:acoustic radiation monopole}
\end{equation}

%%%%%%%%%%%%%%%%%%%%%
%% NUMERICAL IMPLEMENTATION %%
%%%%%%%%%%%%%%%%%%%%%
\section{Numerical Implementation}
Equations~\ref{eq:govern eq 1} and \ref{eq:govern eq 2} are solved using a summation-by-parts finite-difference discretization scheme \citep{DelReyFernandez2014a,Svard2014}, which is discussed in this section. 

The domain ($-L \leq z \leq 0$) is discretized into $N+1$ evenly spaced grid points, $z_i,~i~=0,1, 2,\hdots,N$ where $z_0=-L$ is at the base of the crater where the source is located and $z_N=0$ is at the top of the crater. A field such as $p(z, t)$ is approximated at the grid points with the grid values stored in a vector $\boldsymbol{p}(t)$ with components $p_i(t) \approx p(z_i, t)$. The spatial derivatives are approximated using a summation-by-parts (SBP) differentiation matrix, $\boldsymbol{D}$, such that the vector $\boldsymbol{Dp}$ contains approximations to $\partial p / \partial z$ at the grid points \citep{Karlstrom2016a}. The discrete equations are
\begin{align}
i \omega \boldsymbol{U} + \frac{A}{\rho_\text{amb}} \boldsymbol{D p} & = -\theta_1 (U_0-\hat{U}_0) \boldsymbol{e_0} - \theta_2 (U_N - \hat{U}_N) \boldsymbol{e_N}, \\
i \omega \boldsymbol{p} + \frac{K}{A} \boldsymbol{DU} & = -\theta_3 (p_0 - \hat{p}_0) \boldsymbol{e_0} - \theta_4 (p_N - \hat{p}_N) \boldsymbol{e_N},
\end{align}
where the terms on the right are the implementation of the boundary conditions in the SAT framework. Scalars $\theta_1-\theta_4$ are penalty parameters that are chosen to ensure a stable numerical discretization  \citep{Kozdon2012a}:
\begin{align}
\theta_1 & = \theta_3 = \frac{c}{H_{00}}, \\
\theta_2 & = \theta_4 = \frac{c}{H_{NN}},
\end{align}
where $\boldsymbol{H}$ is a symmetric positive definite matrix such that $\boldsymbol{D} = \boldsymbol{H}^{-1} \boldsymbol{Q}$ where $\boldsymbol{Q}$ is an almost skew symmetric matrix with the property that $\boldsymbol{Q}^T + \boldsymbol{Q} = \text{diag}[-1~0~\hdots~0~1]$ \citep{Karlstrom2016a}.

The variables with a circumflex, $\hat{U}_0, \hat{U}_N, \hat{p}_0, \hat{p}_N$, are the target values for acoustic flow and pressure at the boundary points while $U_0, U_N, p_0$ and $p_N$ are the known grid values. The target values are chosen to satisfy the desired boundary conditions exactly while preserving the characteristic variable carrying information from the interior of the domain to the boundary. The vectors $\boldsymbol{e}_0 = [1~0~\hdots~0]^T$ and $\boldsymbol{e}_N = [0~\hdots~0~1]^T$ isolate the effect of the penalty terms to the boundary points \citep{Karlstrom2016a}.

The characteristic variables that carry information from the interior of the domain to the boundaries are
\begin{align}
p_0-Z_0 U_0 & =\hat{p}_0-Z_0 \hat{U}_0,
\label{eq:characteristic1} \\
p_N+Z_N U_N & = \hat{p}_N+Z_N \hat{U}_N,
\label{eq:characteristic2}
\end{align}
where $Z = \rho c / A$ is the acoustic impedance. The acoustic flow is specified at the base of the crater ($\hat{U}_0$ is known; equation~\ref{eq:volumetric flow rate}) and hence equation~\ref{eq:characteristic1} can be rearranged to give
\begin{equation}
\hat{p}_0 = p_0 + Z_0 (\hat{U}_0 - U_0).
\end{equation}
At the crater outlet, the pressure is related to the acoustic flow by the terminating impedance, $Z_T$:
\begin{equation}
\hat{p}_N = Z_T \hat{U}_N.
\label{eq:outlet imped}
\end{equation}
The terminating impedance is calculated using a flanged opening approximation (equation~\ref{eq:terminating impedance}; \citealp{Kinsler2000, Rossing2004}).
Substituting equation~\ref{eq:outlet imped} into equation~\ref{eq:characteristic2} gives the outlet boundary conditions:
\begin{align}
\hat{U}_N & = \frac{p_N + Z_N U_N}{Z_T+Z_N}, \\
\hat{p}_N & = Z_T \bigg( \frac{p_N + Z_N U_N}{Z_T+Z_N} \bigg).
\end{align}


%%%%%%%%%%%%
%% USING CRES %%
%%%%%%%%%%%%
\section{Using {\bf CRes}}
This section covers the workflow of using {\bf CRes}, which is outlined below, and shows how to use {\bf CRes} to calculate the infrasound signal generated by acoustic resonance of a volcanic crater.
\begin{enumerate}
\item Define model properties and geometry
\item Compute acoustic response function, $T$
\item Specify source function
\item Compute infrasound signal 
\end{enumerate}

\subsection{Define model properties and geometry}

The first step is to define the properties of the air within the crater and the atmosphere by calling the function \texttt{problemParameters.m}. 
\begin{lstlisting}[language=Matlab]
M = problemParameters(); % load parameter values from problemParameters.m
\end{lstlisting}
This function accepts no inputs and outputs a structure \texttt{M} that contains the properties (density, temperature, pressure etc.) of the air in the crater and the atmosphere. Also defined in \texttt{problemParameters.m} is the distance from the crater outlet to where the infrasound signal is calculated. A future release will enable the function to accept input property values. Until then, parameters are specified in the function file. {\bf CRes} allows for properties (density, temperature) to be different within the crater and atmosphere but assumes properties are constant.

The next step is to specify the crater geometry as a matrix with two columns. The first column is the depth (at equally spaced intervals) and the second column is the corresponding radius. The matrix must be arranged so that the depths monotonically decrease starting from the largest value. For the examples included here the crater geometry is from \citet{Johnson2018} and saved as \texttt{Johnson2018.mat}, which can be loaded and formatted by the following code:
\begin{lstlisting}[language=Matlab]
load('Johnson2018'); % load geometry
shape = flipud(geometry); % reformat geometry matrix to be read by solver
\end{lstlisting}
The geometry can be specified in alternative ways (e.g., read from a text file) provided the information is passed to the solver in the format shown in Figure~\ref{fig:geometry}.

\begin{figure}[h!]
\centering
\includegraphics[width=0.6\textwidth]{Fig_geometry}
\caption{Format of two-column matrix containing geometry information.}
\label{fig:geometry}
\end{figure}

\subsection{Compute acoustic response function, $T$}
The bulk of the computational expense is calculating the acoustic response function, $T$. This is done by \texttt{resonance1d.m}, which computes both the crater acoustic response function, $C$, and the atmosphere response function, $P$.

\begin{lstlisting}[language=Matlab]
function output = resonance1d(geometry, depth, freq, Nf, style, order, M)
% computes the acoustic response function for an axisymmetric crater
\end{lstlisting}

\begin{table}[h!]
\begin{tabular}{l | ll }
{\bf Inputs:} & Description & Default Value\\ \hline
  \texttt{geometry} & $(N+1) \times 2$ matrix containing geometry & Required \\
  \texttt{depth} & Maximum crater depth, $z_0$ & Required \\
  \texttt{freq} & Minimum and maximum frequencies & Required \\
  \texttt{Nf} & Number of frequency samples & \texttt{Nf = 100} \\
  \texttt{style} & Order of numerical scheme (4, 6, or 8) & \texttt{order = 8} \\
  \texttt{order} & Model of atmospheric radiation & \texttt{style = 'baffled piston'} \\
  & ('baffled piston' or 'monopole') & \\
  \texttt{M} & Structure containing model parameters & \texttt{M = problemParameters()} \\
  \hline 
  \\[-0.2cm]
  {\bf Outputs:} & Description & Dimension \\ \hline
  \texttt{output.geometry} & Matrix containing geometry & $(N+1) \times 2$ \\
  \texttt{output.depth} & Maximum crater depth & 1\\
  \texttt{output.f} & Frequency vector with \texttt{Nf} entries & $1 \times$ \texttt{Nf}\\
  \texttt{output.T} & Transfer function for pressure and acoustic & $2(N+1) \times$ \texttt{Nf} \\
  & flow at crater depth positions in \texttt{geometry} & \\
  \texttt{output.pOutlet} &  Transfer function for outlet pressure& $1 \times$ \texttt{Nf} \\
  \texttt{output.vOutlet} & Transfer function for outlet velocity & $1 \times$ \texttt{Nf} \\
  \texttt{output.P} & Transfer function for pressure at distance $r$ & $1 \times$ \texttt{Nf} \\
  & from crater outlet& \\
\end{tabular}
\caption{Inputs and outputs of \texttt{resonance1d.m}. Transfer functions map an impulsive excitation (expressed as volumetric flow rate) at the base of crater to the listed quantity.}
\end{table}

\begin{figure}[h!]
\centering
\includegraphics[width=1\textwidth]{Fig_outputs}
\caption{Format outputs from \texttt{resonance1d.m}.}
\label{fig:outputs}
\end{figure}

The function \texttt{flanged\_opening.m} is used to calculate the terminating impedance (equation~\ref{eq:terminating impedance}) while \texttt{pressurePerturbation.m} is used to compute the atmosphere response function. There are two possible models of the atmospheric radiation: baffled piston (equation~\ref{eq:acoustic radiation}) and monopole (equation~\ref{eq:acoustic radiation monopole}).

\newpage
\subsection{Specify source function}

In {\bf CRes}, acoustic waves are excited by a source at the base of the crater, which is expressed as a volumetric flow rate of air within the crater being pushed upwards, or pulled downwards, by the source process (m$^3$/s). The source can be specified by \texttt{sourceFunction.m}, which allows for either a Gaussian or Brune function \citep{Brune1970}. 
\begin{lstlisting}[language=Matlab]
function [S, f, s, t] = sourceFunction(A, L, srcStyle, resParams)
% computes source function in (s) time and (S) frequency domains
\end{lstlisting}
\begin{table}[h!]
\begin{tabular}{l | ll }
{\bf Inputs:} & Description & \\ \hline
\texttt{A} & Source amplitude & \\
\texttt{L} & Source width & \\
\texttt{srcStyle} & Functional form of source & \texttt{'Gauss'} or \texttt{'Brune'} \\
\texttt{resParams} & Parameters to ensure source description & \texttt{resParams =|T N|} \\
& is consistent with transfer function &  \texttt{T} = total time, \texttt{N} = number of grid points\\
\hline 
\\[-0.2cm]
{\bf Outputs:} & Description & \\ \hline
\texttt{S} &  Source in frequency domain &  \\
\texttt{f} & Frequency &  \\
\texttt{s} & Source in time domain &  \\
\texttt{t} &  Time &  \\
\end{tabular}
\caption{Inputs and outputs of \texttt{sourceFunction.m}.}
\end{table}
Alternative source functions or user defined source data can also be used by {\bf CRes} provided the source is discretized in the same way as the transfer function. 

\subsection{Compute infrasound signal}
 Once the transfer function from the volumetric flow rate at the base of the crater to the receiver, \texttt{output.P}, and the source function in the frequency domain, \texttt{S}, have been calculated, it is straightforward to compute the infrasound signal by multiplying the source with the transfer function in the frequency domain (equation~\ref{eq:model freq}):
\begin{lstlisting}[language=Matlab]
dP = output.P .* S(1:N/2+1);
\end{lstlisting}
where \texttt{dP} is the excess pressure in the frequency domain. Note that the transfer function is only specified at positive frequencies so only the positive frequencies from the source (\texttt{1:N/2+1}) are used in the multiplication. The inverse Fourier transform can be used to convert the signal back to the time domain:
\begin{lstlisting}[language=Matlab]
dP_pos = dP(1:N/2+1);
dP_full = [dP_pos conj(dP_pos(end-1:-1:2))]; % reflect about f = 0. Take complex conjugate for negative frequencies
dP_full(N/2+1) = real(dP_full(N/2+1)); % entry at Nyquist must be real
dP_time = ifft(dP_full,'symmetric')/dt; % inverse fourier transform
\end{lstlisting}

The resonant frequency, \texttt{f0}, and quality factor, \texttt{Q}, of the infrasound signal can be computed using \texttt{resPeakProps.m}.
\begin{lstlisting}[language=Matlab]
[f0,Q] = resPeakProps(output.f,dP);
\end{lstlisting}



\newpage
\section{Examples}

For demonstration purposes, two example script files are included that simulate crater acoustic resonance at Villarrica volcano. \texttt{example1.m} computes the resonant modes of Villarrica's crater for a single depth while \texttt{example2.m} shows how to compute the resonant frequency and quality factor as a function of the position of the lava lake within the crater. The crater geometry has been previously calculated from visual observations using structure-from-motion \citep{Johnson2018} and is saved as \texttt{Johnson2018.mat}.

\begin{figure}[h!]
\centering
\includegraphics[width=0.97\textwidth]{Fig_example1}
\caption{Outputs from \texttt{example1.m} showing (a) crater geometry with lava lake at 120~m below the crater rim, (b) infrasound signal in the time domain and (c) in the frequency domain. Insets show the source (volumetric flow rate at base of crater/surface of lava lake).}
\end{figure}

\begin{figure}[h!]
\centering
\includegraphics[width=0.97\textwidth]{Fig_example2}
\caption{Outputs from \texttt{example2.m} showing simulated infrasound signal as a function of depth. (a) Crater geometry. (b) Resonant frequency and (c) quality factor as a function of depth. Infrasound signal in the (d) time and (e) frequency domains for crater depths of (i) 50~m, (ii) 80~m, and (iii) 120~m. Acoustic waves are excited by a Gaussian pulse with $\sigma=0.2$~s, the same source as for \texttt{example1.m}.}
\end{figure}


%\newpage
%\section{{\bf CRes} Functions}
%This section contains the details and syntax of the different function files used by {\bf CRes}:
%\begin{enumerate}[label=\roman*]
%\item \texttt{resonance1d}
%\item \texttt{flanged\_opening}
%\item \texttt{problemParameters}
%\item \texttt{pressurePerturbation}
%\item \texttt{resPeakProps}
%\item \texttt{sourceFunction}
%\end{enumerate}
%
%\subsection{resonance1d}
%\begin{lstlisting}[language=Matlab]
%function output = resonance1d(geometry, depth, freq, Nf, style, order, M)
%% computes the acoustic response function for an axisymmetric crater
%%
%% INPUT
%% geometry = vector containing the depth (:,1) and radius (:,2) of the crater starting from the deepest depth
%% depth = depth of base of crater
%% freq = maximum and minimum frequency of interest
%% Nf = number of frequency samples
%% style = sound radiation description ('baffled piston' or 'monopole')
%% order = internal order of accuracy
%% M = model parameters
%%
%% OUTPUT
%% solver outputs are saved into the structure output
%% output.geometry = crater geometry in the same format as input geometry
%% output.depth = depth of base of crater
%% output.f = frequency vector
%% output.T = transfer function
%% output.pOutlet = outlet pressure transfer function
%% output.vOutlet = outlet velocity transfer function
%% output.P = far-field pressure perturbation transfer function
%\end{lstlisting}
%
%\subsection{problemParameters}
%This function defines the properties of crater and atmosphere and saves these parameters into a structure that can be accessed by the other functions. 
%
%\begin{lstlisting}[language=Matlab]
%function M = problemParameters()
%% Store properties of atmosphere and crater in structure M
%%
%% INPUT
%% No inputs
%%
%% OUTPUT
%% M = structure containing properties of atmosphere and crater
%% M.gamma = ratio of heat capacities
%% M.r = distance from outlet to receiver
%% M.R = specific gas constant
%% M.TA = atmospheric temperature [C]
%% M.rhoA = density of atmospheric air [kg/m^3]
%% M.cA = sound of sound in atmosphere [m/s]
%% M.TC = crater temperature [C]
%% M.rhoC = density of air within crater [kg/m^3]
%% M.cC = speed of sound within crater [m/s]
%% M.pC = pressure inside crater [Pa]
%\end{lstlisting}
%
%
%\subsection{pressurePerturbation}
%\texttt{pressurePerturbation.m} takes the outputs of \texttt{resonance1d.m}, specifically the acoustic flow at the outlet, and computes the pressure perturbation at a specified distance from the crater outlet. Here, we include two possible axisymmetric acoustic radiation models: 
%\begin{enumerate}
%\item Baffled piston \citep{Rossing2004}:
%\begin{equation}
%\Delta p(\omega,r) = i\omega \exp(-ikr) \frac{\rho_a a^2}{2r} \bigg[ \frac{2J_1(ka\sin \theta)}{ka \sin \theta}\bigg] \frac{U(\omega,0)}{\pi a^2},
%\end{equation}
%where $\Delta p(\omega,r)$ is the excess pressure at a distance $r$ from the crater outlet, $J_1$ is a Bessel function of order one, $\theta$ is the angle between the negative $z-$axis and the receiver (e.g., $\theta=\pi/2$ for a receiver located on the plane perpendicular to crater orientation), $\rho_a$ is the density of the atmosphere, $a$ is the crater radius at the outlet, and $U(\omega,0)$ is the acoustic flow at the crater outlet. The baffled piston model accounts for the finite dimension of the crater outlet.
%
%\item Monopole \citep{Woulff1976,Johnson2014}:
%\begin{equation}
%\Delta p(\omega, r) = i \omega \exp(-ikr) \frac{\rho_a a^2}{2r}\frac{U(\omega,0)}{\pi a^2}.
%\end{equation}
%Note that the baffled piston model reduces to the monopole model in the low frequency limit when $ka \ll 1$.
%\end{enumerate}
%
%\begin{figure}[h!]
%\centering
%\includegraphics[width=0.9\textwidth]{Fig_PressurePerturbation}
%\end{figure}
%
%It is noted that an alternative wave propagation code could be used to propagate the signal from the crater outlet to the infrasound receiver. For instance, if the surrounding topography outside of the crater is too complex to be approximated as axisymmetric then a 3D wave propagation code such as \emph{infraFDTD} \citep{Kim2011} could be used. 
%
%\begin{lstlisting}[language=Matlab]
%function P = pressurePerturbation(input, style, M)
%% Computes pressure perturbation at specified distance from outlet
%% 
%% INPUT
%% input = output structure from resonance1d
%% style = style of acoustic radiation. Options are "baffled piston" or "monopole"
%% M = structure containing model parameters
%%
%% OUTPUT
%% P = pressure perturbation in frequency domain at specified distance from outlet
%\end{lstlisting}
%
%\subsection{flanged\_opening}
%\begin{lstlisting}[language=Matlab]
%function Z = flanged_opening(f,rho,c,a)
%% computes terminating impedance of opening through rigid flange
%%
%% INPUT
%% omega = angular frequency []
%% rho = density of atmospheric air [kg/m^3]
%% c = sound speed in atmosphere [m/s]
%% a = radius of outlet [m]
%%
%% OUTLET
%% Z = terminating impedance
%\end{lstlisting}
%
%
%\subsection{resPeakProps}
%\texttt{resPeakProps.m} computes the resonant frequency and quality factor of the fundamental resonant mode of the provided amplitude spectra. 
%
%\begin{lstlisting}[language=Matlab]
%function [f0, Q] = resPeakProps(f,G)
%% computes resonant frequency and quality factor of fundamental resonant mode.
%%
%% INPUT
%% f = frequency vector
%% G = amplitude spectra
%%
%% OUTPUT
%% f0 = resonant frequency
%% Q = quality factor
%\end{lstlisting}
%
%
%\subsection{sourceFunction}
%\texttt{sourceFunction.m} can be used to compute the excitation source in both time and frequency domains. Currently there are two possible source styles to choose from: 1.) Gaussian:
%\begin{equation}
%s(t) = S\exp \bigg( - \frac{1}{2} \frac{t^2}{\sigma^2} \bigg),
%\end{equation}
%where $S$ is the source amplitude and $\sigma$ is the source width, and 2.) Brune
%\begin{equation}
%s(t) = StH(t) \exp \bigg( - \frac{t}{\sigma} \bigg),
%\end{equation}
%where $H$ is the Heaviside function. Alternatively, instead of using \texttt{sourceFunction.m} the user can define their own source function.
%
%\begin{lstlisting}[language=Matlab]
%function [S,f,s,t] = sourceFunction(A,L,srcStyle,resParams)
%% Compute source function in the time and frequency domains.
%% 
%% INPUT
%% A = source amplitude
%% L = source width
%% srcStyle = style of source mechanism ('Gauss' or 'Brune')
%% resParams = parameters to ensure consistency with resonance1d simulation
%%
%% OUTPUT
%% S = source function in frequency domain
%% f = frequency vector
%% s = source function in time domain
%% t = time vector
%\end{lstlisting}
%


\newpage
\bibliographystyle{elsarticle-harv}
\bibliography{/Users/lwat054/Documents/Stanford_University/Research/References/Bibliography/library.bib}

\end{document}




